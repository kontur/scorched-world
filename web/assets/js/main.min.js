function Player(a){function b(a){return $.extend(c,a)}var c={color:16777215};this.options=b(a),this.position=null,this.mesh=null,this.direction=null,this.indicator=null,this.fireForce=0,this.fireButtonTimeout=null,this.init=function(){console.log("Player.init()",this.options.color);var a=new THREE.IcosahedronGeometry(1,0),b=new THREE.MeshPhongMaterial({ambient:16777215,color:this.options.color,specular:this.options.color,shininess:10,shading:THREE.FlatShading});this.mesh=new THREE.Mesh(a,b),this.obj=new THREE.Object3D;var c=2,d=new THREE.CylinderGeometry(.15,.5,c);d.applyMatrix((new THREE.Matrix4).makeTranslation(0,c/2,0));var e=new THREE.MeshPhongMaterial({ambient:16711680,color:65535,specular:39423,shininess:30,shading:THREE.FlatShading});this.canon=new THREE.Mesh(d,e),this.obj.add(this.mesh),this.obj.add(this.canon),this.canon.rotateX(45*Math.PI/180),this.canon.rotationAutoUpdate},this.setPosition=function(a){this.position=a,this.obj.translateX(a.x),this.obj.translateY(a.y),this.obj.translateZ(a.z);var b=new THREE.Geometry;b.vertices.push(this.position),b.vertices.push(new THREE.Vector3(this.position.x,10,this.position.z));var c=new THREE.LineBasicMaterial({color:16711680});this.indicator=new THREE.Line(b,c)},this.fire=function(a){var b=new Projectile;console.log("Player.fire()",a),b.direction=this.getIndicator().multiplyScalar(a),b.mass=.151,b.setPosition(this.position.clone()),$(this).trigger("PROJECTILE_FIRED",b)},this.addAngle=function(a){this.canon.rotation.x+a>0&&this.canon.rotation.x+a<Math.PI/2&&this.canon.rotateX(a),console.log("Player.addAngle()",this.canon.rotation.x),this.getIndicator()},this.addRotation=function(a){this.obj.rotateOnAxis(new THREE.Vector3(0,1,0),a),console.log("Player.addRotation",this.obj.rotation.y),this.getIndicator()},this.getIndicator=function(a){a||(a=1);var b=new THREE.Matrix4;b=b.extractRotation(this.obj.matrix);var c=new THREE.Vector3(0,0,1);c=c.applyMatrix4(b);var d=new THREE.Matrix4;d=d.extractRotation(this.canon.matrix);var e=(new THREE.Matrix4).makeRotationX(-Math.PI/4),f=new THREE.Vector3(0,1,1);f=f.applyMatrix4(e),f=f.applyMatrix4(d),f=f.applyMatrix4(b);var g=new THREE.Geometry;g.vertices.push(this.position),g.vertices.push(this.position.clone().add(f.clone().multiplyScalar(1+5*a)));var h=new THREE.LineBasicMaterial({color:"rgb("+Math.round(255*a)+", 0, 0)"});for(this.indicator.add(new THREE.Line(g,h));this.indicator.children.length>5;)this.indicator.children.shift();return f}}function HumanPlayer(a){function b(){console.log("HumanPlayer.setupControls()"),$(window).on("keydown",c),$(window).on("keyup",d)}function c(a){if(!f.controlsEnabled)return!1;var b=5;switch(a.keyCode){case 40:f.addAngle(b*(Math.PI/180));break;case 38:f.addAngle(-b*(Math.PI/180));break;case 39:f.addRotation(-b*(Math.PI/180));break;case 37:f.addRotation(b*(Math.PI/180));break;case 32:f.fireButtonTimeout||(f.fireButtonTimeout=setTimeout(e,5))}}function d(a){return f.controlsEnabled?void("32"==a.keyCode&&(clearTimeout(f.fireButtonTimeout),f.fire(f.fireForce/100),f.fireForce=0,f.fireButtonTimeout=!1)):!1}function e(){f.fireForce++,f.fireForce>100&&(f.fireForce=100),f.fireButtonTimeout=setTimeout(e,5),f.getIndicator(Math.min(100,f.fireForce)/100)}console.log("HumanPlayer()");var f=this;this.isHuman=!0,this.controlsEnabled=!1,this.enableControls=function(){this.controlsEnabled=!0,console.log("Player controls enabled")},this.disableControls=function(){this.controlsEnabled=!1,console.log("Player controls disabled")},Player.call(this,a),b()}function AIPlayer(a){Player.call(this,a),this.isHuman=!1;var b=[];this.autofire=function(){var a=this;setTimeout(function(){var c=a.guessShot([],[],[]);a.animateTo(c.rotationH,c.rotationV),setTimeout(function(){a.fire(c.force),$(window).on("PROJECTILE_IMPACT",function(b,d){console.log("AIPlayer.autofire",d);var e=Scene.getTerrain().closestOtherPlayer(d.hit.point,a.position);c.closest=d.hit.point.sub(e)}),console.log("shot:",c),b.push(c),a.getIndicator()},500)},1e3)},this.animateTo=function(a,b){this.canon.rotateX(b),this.obj.rotateY(a)},this.guessShot=function(){var a=Math.random()*Math.PI,b=Math.random()*Math.PI/2-Math.PI/4,c=.5*Math.random()+.5;return{rotationH:a,rotationV:b,force:c}}}var CameraManager=function(){var a,b,c,d,e=function(){a=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,150)},f=function(a,e){c=a,d=e,b=e},g=function(c,d){var e=c.clone().sub(a.position.clone());a.applyMatrix((new THREE.Matrix4).setPosition(e)),a.lookAt(d),b=d},h=function(){if(a.position&&c){var e=c.clone().sub(a.position.clone());e.multiplyScalar(.15),a.applyMatrix((new THREE.Matrix4).setPosition(e)),a.lookAt(b)}b!=d&&a.lookAt(b)};return{init:e,animateTo:f,setTo:g,update:h,getCamera:function(){return a}}}(),Force=function(a){this.direction=a};Force.prototype={};var Game=function(){function a(){console.log("----------------------------------"),console.log("Game.nextTurn()",d,c[d].isHuman),$(window).on("PROJECTILE_IMPACT",b);var a=c[d].position.clone();a.x-=15,a.z-=15,a.y=15,CameraManager.animateTo(a,c[d].position),c[d].isHuman?c[d].enableControls():c[d].autofire()}function b(){console.log("Game.updateDamage()"),$(window).off("PROJECTILE_IMPACT",b),c[d].isHuman&&c[d].disableControls(),d++,d>=c.length&&(d=0),a()}var c,d,e=function(b){c=b,Scene.init(),Scene.start();for(p in c)c[p].init(),c[p].setPosition(Scene.getTerrain().playerPositions[p]),Scene.addPlayer(c[p]);d=0,setTimeout(a,1500)};return{start:e,reset:e}}();HumanPlayer.prototype=new Player,HumanPlayer.constructor=HumanPlayer,AIPlayer.prototype=new Player,AIPlayer.constructor=AIPlayer;var Projectile=function(){var a=new THREE.SphereGeometry(.25,4,4),b=new THREE.MeshBasicMaterial({color:16711935}),c=new THREE.Mesh(a,b),d=null,e=new THREE.Vector3(0,-1,0),f=new THREE.Raycaster(this.position,e);this.mass=.1,this.direction=new THREE.Vector3(0,0,0),this.position=new THREE.Vector3(0,0,0),this.drag=.01,this.obj=new THREE.Object3D,this.obj.add(c),this.obj.position=new THREE.Vector3(0,0,0),this.applyForce=function(a){this.direction=this.direction.add(a.direction.clone().multiplyScalar(1+this.mass))},this.setPosition=function(a){this.position=a},this.update=function(){this.position=this.position.add(this.direction);var a=(new THREE.Vector3).subVectors(this.position,this.obj.position);this.obj.translateX(a.x),this.obj.translateY(a.y),this.obj.translateZ(a.z)},this.checkPlaneCollision=function(a){f.set(this.position,e);var b=f.intersectObject(a);return console.log("check",b,d),b.length?(d=b,0/0==d[0].point.x&&(console.log("--overwriting NaN point"),d[0].point=this.position),!1):(console.log("checkPlaneCollision no intersect",d),d||(d=[{point:this.position}]),!0)},this.getPlaneCollision=function(){return console.log("Projectile.getPlaneCollision",d),d?d:!1}},Scene=function(){function a(){if(requestAnimationFrame(a),d&&d.length)for(p in d)d[p].applyForce(gravity),d[p].update(),d[p].checkPlaneCollision(f.objForHittest)&&(f.showImpact(d[p].getPlaneCollision()[0]),$(window).trigger("PROJECTILE_IMPACT",{hit:d[p].getPlaneCollision()[0]}),b.remove(d[p].obj),d=[]);CameraManager.update(),c.render(b,CameraManager.getCamera())}var b,c,d,e,f,g=function(){console.log("Scene.init()"),b=new THREE.Scene,CameraManager.init(),c=new THREE.WebGLRenderer({canvas:document.getElementById("gamecanvas")}),c.setSize(window.innerWidth,window.innerHeight);var a=new THREE.DirectionalLight(16777215,.5);a.position.set(0,1,0),b.add(a),f=new Terrain,f.init(),b.add(f.obj),f.generatePlayerPositions(2,b),gravity=new Force(new THREE.Vector3(0,-.055,0)),d=[]},h=function(){a(),CameraManager.setTo(new THREE.Vector3(-100,50,0),new THREE.Vector3(50,10,50)),setTimeout(function(){CameraManager.animateTo(new THREE.Vector3(-30,15,0),new THREE.Vector3(0,0,0))},250)},i=function(a){b.add(a.obj),$(a).on("PROJECTILE_FIRED",function(a,b){j(b)}),e=a,b.add(a.indicator),console.log("addPlayer",a.indicator)},j=function(a){d.push(a),b.add(a.obj)};return{init:g,start:h,addPlayer:i,addProjectile:j,getTerrain:function(){return f}}}();Terrain=function(){function a(){return b.vertices[Math.floor(Math.random()*b.vertices.length)]}var b,c,d,e,f=400,g=400,h=60,i=60,j=80,k=80;this.init=function(){b=new THREE.PlaneGeometry(f,g,h,i);for(var a=0;a<b.vertices.length;a++)b.vertices[a].z+=2*Math.random(),b.vertices[a].x+=Math.random()-.5,b.vertices[a].y+=Math.random()-.5;b.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),b.verticesNeedUpdate=!0;var j=new THREE.MeshDepthMaterial;this.obj=new THREE.Object3D,c=new THREE.Mesh(b,j),c.userData={name:"shaded"},d=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:1118481,wireframe:!0,wireframeLinewidth:.5})),d.userData.name="wire",e=new THREE.Object3D,e.userData.name="effects",this.obj.add(c),this.obj.add(d),this.obj.add(e),this.objForHittest=c},this.generatePlayerPositions=function(b){for(var c=[],d=0;b>d;d++){for(var e,f=!1;!f;)if(e=a(),e.x>-j/2&&e.x<j/2&&e.z>-k/2&&e.z<k/2){f=!0;for(var g=0;g<c.length;g++)c[g]==e&&(f=!1)}c.push(e)}return this.playerPositions=c,this.playerPositions},this.closestOtherPlayer=function(a,b){if(console.log("Terrain.closestOtherPlayer",a,b,a.x),isNaN(a.x))return!1;var c=99999999,d=null;for(pos in this.playerPositions)if(this.playerPositions[pos]!=b){var e=a.distanceTo(this.playerPositions[pos]);c>e&&(d=this.playerPositions[pos])}if(!d)throw new Error("Terrain.closestOtherPlayer() could not determine closest player to ",a);return{position:d,distance:c}},this.showImpact=function(a){var b=new THREE.SphereGeometry(1,4,4);b.applyMatrix((new THREE.Matrix4).setPosition(a.point));var c=new THREE.MeshBasicMaterial({color:16724736}),d=new THREE.Mesh(b,c);Utils.Object3DgetChildByName(this.obj,"effects").add(d)}};var UI=function(){function a(){var a=$(window).width(),b=$(window).height();$("#gamecanvas").css("width",a+"px"),$("#gamecanvas").css("height",b+"px")}function b(){Game.reset()}function c(){var a=[new AIPlayer({color:16711935,name:"Foobar"}),new AIPlayer({color:16737792,difficulty:0,name:"Robert the Robot"})];Game.start(a)}var d=function(){$(window).on("resize",a),a(),$("#ui-reset-scene").on("click",b),$("#ui-start-game").on("click",c)};return{init:d}}(),Utils=function(){return{Object3DgetChildByName:function(a,b){console.log(a,b);for(child in a.children)if(a.children[child].userData&&a.children[child].userData.name&&a.children[child].userData.name==b)return a.children[child];return!1}}}();$(function(){UI.init()});