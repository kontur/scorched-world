function AIPlayer(a){Player.call(this,a),this.isHuman=!1;var b=[];this.autofire=function(){var a=this;setTimeout(function(){var c=null,d=null;if(b.length)for(e in b)(null===c||b[e].distance<c)&&(d=b[e]);var e=a.guessShot(d);a.animateTo(e.rotationH,e.rotationV),setTimeout(function(){a.fire(e.force),$(window).on("PROJECTILE_IMPACT",function(c,d){var f=Scene.getTerrain().closestOtherPlayer(d.point,a.position);e.distance=f.distance,e.hit=f.position,b.push(e),$(window).off("PROJECTILE_IMPACT")}),a.getIndicator()},500)},1e3)},this.animateTo=function(a,b){this.canon.rotation.x=b,this.obj.rotation.y=a,this.checkTangent(Scene.getTerrain().objForHittest)},this.guessShot=function(a){var b,c,d;if(null!==a){var e=Scene.getTerrain().closestOtherPlayer(a.hit,this.position),f=this.position.distanceTo(e.position);console.log("distance to next player",f),console.log("---RATIO shot distance to distance to player",a.distance/f);var g=Math.max(a.distance/f,.01),h=Math.random()*Math.PI/.5-Math.PI/1*g*g,i=Math.random()*Math.PI/2-Math.PI/4*g*g;console.log("RANDOM",a,h,i),b=a.rotationH+h,c=a.rotationV+i,d=a.force+Math.random()/4}else b=Math.random()*Math.PI,c=Math.random()*Math.PI/2-Math.PI/4,d=.5*Math.random()+.5;return b=THREE.Math.clamp(b,0,2*Math.PI),c=THREE.Math.clamp(c,.25,Math.PI/4),d=THREE.Math.clamp(d,.1,1),{rotationH:b,rotationV:c,force:d}}}function HumanPlayer(a){function b(){console.log("HumanPlayer.setupControls()"),$(window).on("keydown",c),$(window).on("keyup",d)}function c(a){if(!f.controlsEnabled)return!1;switch(f.rotationStep=Math.min(f.rotationStepMax,f.rotationStep*f.rotationStepMultiplier),a.keyCode){case 40:f.addAngle(f.rotationStep*(Math.PI/180));break;case 38:f.addAngle(-f.rotationStep*(Math.PI/180));break;case 39:f.addRotation(-f.rotationStep*(Math.PI/180));break;case 37:f.addRotation(f.rotationStep*(Math.PI/180));break;case 32:f.fireButtonTimeout||(f.fireButtonTimeout=setTimeout(e,5))}}function d(a){return f.controlsEnabled?(f.rotationStep=1,void("32"==a.keyCode&&(clearTimeout(f.fireButtonTimeout),f.fire(f.fireForce/100),f.fireForce=0,f.fireButtonTimeout=!1))):!1}function e(){f.fireForce++,f.fireForce>100&&(f.fireForce=100),f.fireButtonTimeout=setTimeout(e,5),f.getIndicator(Math.min(100,f.fireForce)/100)}console.log("HumanPlayer()"),Player.call(this,a),b();var f=this;f.rotationStep=1,f.rotationStepMultiplier=1.1,f.rotationStepMax=10,this.isHuman=!0,this.controlsEnabled=!1,this.enableControls=function(){this.controlsEnabled=!0,console.log("Player controls enabled")},this.disableControls=function(){this.controlsEnabled=!1,console.log("Player controls disabled")}}function Player(a){function b(a){return $.extend(c,a)}var c={color:16777215};this.options=b(a),this.position=null,this.mesh=null,this.bbox=null,this.direction=null,this.indicator=null,this.cameraPosition=null,this.fireForceFactor=2,this.fireForce=0,this.fireButtonTimeout=null,this.life=100,this.id=null,this.name=null,this.init=function(){console.log("Player.init()",this.options.color),this.id=this.options.id,this.name=this.options.name;var a=new THREE.IcosahedronGeometry(1,0),b=new THREE.MeshPhongMaterial({ambient:16777215,color:this.options.color,specular:this.options.color,shininess:10,shading:THREE.FlatShading});this.mesh=new THREE.Mesh(a,b),this.obj=new THREE.Object3D;var c=2,d=new THREE.CylinderGeometry(.15,.5,c);d.applyMatrix((new THREE.Matrix4).makeTranslation(0,c/2,0));var e=new THREE.MeshPhongMaterial({ambient:16711680,color:65535,specular:39423,shininess:30,shading:THREE.FlatShading});this.canon=new THREE.Mesh(d,e),this.obj.add(this.mesh),this.obj.add(this.canon),this.canon.rotateX(45*Math.PI/180),this.canon.rotationAutoUpdate,this.bbox=new THREE.BoundingBoxHelper(this.obj,16711680),this.bbox.update()},this.setPosition=function(a){this.position=a,this.obj.translateX(a.x),this.obj.translateY(a.y),this.obj.translateZ(a.z);var b=new THREE.Geometry;b.vertices.push(this.position),b.vertices.push(new THREE.Vector3(this.position.x,10,this.position.z));var c=new THREE.LineBasicMaterial({color:this.options.color});this.indicator=new THREE.Line(b,c)},this.fire=function(a){console.log("Player.fire()",a);var b=this.getIndicator().multiplyScalar(a).multiplyScalar(this.fireForceFactor),c=.151,d=new Projectile({direction:b,mass:c,player:this});this.cameraPosition=CameraManager.getLocation(),$(this).trigger("PROJECTILE_FIRED",d)},this.addAngle=function(a){this.canon.rotation.x+a>0&&this.canon.rotation.x+a<Math.PI/2&&this.canon.rotateX(a),this.bbox.update(),this.getIndicator()},this.addRotation=function(a){this.obj.rotateOnAxis(new THREE.Vector3(0,1,0),a),this.bbox.update(),this.getIndicator()},this.getIndicator=function(a){a||(a=1);var b=new THREE.Matrix4;b=b.extractRotation(this.obj.matrix);var c=new THREE.Vector3(0,0,1);c=c.applyMatrix4(b);var d=new THREE.Matrix4;d=d.extractRotation(this.canon.matrix);var e=(new THREE.Matrix4).makeRotationX(-Math.PI/4),f=new THREE.Vector3(0,1,1);for(f=f.applyMatrix4(e),f=f.applyMatrix4(d),f=f.applyMatrix4(b);this.indicator.children.length>0;)this.indicator.children.shift();var g=new THREE.Geometry;g.vertices.push(this.position),g.vertices.push(this.position.clone().add(f.clone().multiplyScalar(1+5*a)));var h=new THREE.LineBasicMaterial({color:"rgb("+Math.round(255*a)+", 0, 0)"});return this.indicator.add(new THREE.Line(g,h)),this.indicator.updateMatrix(),f},this.checkTangent=function(){},this.registerHit=function(){console.log("Player.registerHit"),this.life-=100,this.life<=0&&this.terminate(),$(this).trigger("CHANGE_LIFE")},this.terminate=function(){console.log("Player exploded")}}var CameraManager=function(){function a(){$(window).on("keydown",b)}function b(a){var b=.051;switch(a.keyCode){case 68:c("x",-b);break;case 65:c("x",b);break;case 87:c("y",-b);break;case 83:c("y",b)}}function c(a,b){"x"==a?(e.rotation.y+=b,e.rotation.y>2*Math.PI?e.rotation.y-=2*Math.PI:e.rotation.y<0&&(e.rotation.y+=2*Math.PI),e.updateMatrix()):"y"==a&&(f.rotation.x+=b,f.updateMatrix())}var d,e,f,g,h,i,j,k,l,m,n,o=null,p=null,q=null,r={maxV:-1.4,minV:1.4,playerV:.8},s=!1,t=!1,u=function(){e=new THREE.Object3D,f=new THREE.Object3D,g=new THREE.Object3D,d=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,150),d.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI),f.translateZ(-25),f.add(d),g.add(f),g.matrixAutoUpdate=!0,e.add(g),a(),v(new THREE.Vector3(0,50,0),new THREE.Vector3(0,0,0),Math.PI/4,Math.PI/4),l=new THREE.Object3D,m=new THREE.AxisHelper(15),n=new THREE.AxisHelper(25)},v=function(a,b,c,d){o=a,h=b,p=null!==c?c:0,q=null!==d?THREE.Math.clamp(r.minV,r.maxV,d):0},w=function(a,b){var c=a.clone().sub(e.position.clone());e.applyMatrix((new THREE.Matrix4).setPosition(c)),g.lookAt(b),h=b,o=a},x=function(){if(e.position&&null!==o){var a=o.clone().sub(e.position.clone());a.length()>.1?(a.multiplyScalar(.15),e.applyMatrix((new THREE.Matrix4).setPosition(a)),e.updateMatrix()):o=null}if(h&&(g.lookAt(h),!0===t&&(l.remove(i),i=new THREE.ArrowHelper(new THREE.Vector3(0,1,0),h.clone(),10,16776960),l.add(i))),e.rotation&&null!==p){var b=e.rotation.y-p;b>Math.PI&&(b=-(2*Math.PI-b)),Math.abs(b)<.1?p=null:e.rotation.y+=.1}if(f.rotation&&null!==q){var b=q-f.rotation.x;Math.abs(b)<.1?q=null:f.rotation.x+=b/4}},y=function(a){d&&(d.aspect=a,d.updateProjectionMatrix())},z=function(){s=!0},A=function(){s=!1},B=function(){return{position:e.position.clone(),lookAt:h,targetRotationH:p}},C=function(a){if(a===!0){t=a;var b=new THREE.BoxGeometry(2,2,2),c=new THREE.MeshBasicMaterial({color:65535,wireframe:!0});j=new THREE.Mesh(b,c),e.add(j);var d=new THREE.BoxGeometry(5,5,5),h=new THREE.MeshBasicMaterial({color:16776960,wireframe:!0});k=new THREE.Mesh(d,h),g.add(k),f.add(m),e.add(n)}else t=!1,e.remove(j),g.remove(k),f.remove(m),e.remove(n),l.remove(i)};return{init:u,animateTo:v,setTo:w,update:x,updateAspect:y,enableControls:z,disableControls:A,getLocation:B,getCamera:function(){return d},getCameraDolly:function(){return e},getCameraDefaults:function(){return r},getDebugHelper:function(){return l},debug:C}}(),Force=function(a){this.direction=a};Force.prototype={};var Game=function(){function a(){if(console.log("----------------------------------"),console.log("Game.nextTurn()",f,e[f].isHuman),e[f].life<=0)return console.log("skip this player",e[f].name),c(),void a();$(window).on("PROJECTILE_IMPACT",b);var d=e[f].position.clone();d.y=35,CameraManager.animateTo(d,e[f].position,0,CameraManager.getCameraDefaults().playerV),e[f].isHuman?(e[f].enableControls(),CameraManager.enableControls()):e[f].autofire()}function b(){console.log("Game.updateDamage()"),$(window).off("PROJECTILE_IMPACT",b);var g=d();g.length>1?(e[f].isHuman&&(e[f].disableControls(),CameraManager.disableControls()),c(),setTimeout(a,1500)):UI.showWin(g[0])}function c(){f++,f>=e.length&&(f=0)}function d(){var a=[];for(var b in e)e[b].life>0&&a.push(e[b]);return a}var e,f,g=function(a){Scene.init(a),Scene.start(),CameraManager.disableControls()},h=function(a){e=a;for(p in e)e[p].init(),e[p].setPosition(Scene.getTerrain().playerPositions[p]),Scene.addPlayer(e[p])},i=function(){f=0,setTimeout(a,1500)};return{init:g,addPlayers:h,start:i,reset:i,getPlayers:function(){return e}}}();AIPlayer.prototype=new Player,AIPlayer.constructor=AIPlayer,HumanPlayer.prototype=new Player,HumanPlayer.constructor=HumanPlayer;var Projectile=function(a){var b={mass:.1,direction:new THREE.Vector3(0,0,0),player:null},a=$.extend(b,a),c=new THREE.SphereGeometry(.25,4,4),d=new THREE.MeshBasicMaterial({color:16711935}),e=new THREE.Mesh(c,d),f=1,g=null,h=new THREE.Vector3(0,-1,0),i=new THREE.Raycaster(this.position,h);this.drag=.01,this.obj=new THREE.Object3D,this.obj.add(e),this.obj.position=new THREE.Vector3(0,0,0),this.position=a.player.position.clone(),this.position.y+=f,this.applyForce=function(b){a.direction=a.direction.add(b.direction.clone().multiplyScalar(1+a.mass))},this.update=function(){this.position=this.position.add(a.direction);var b=(new THREE.Vector3).subVectors(this.position,this.obj.position);this.obj.translateX(b.x),this.obj.translateY(b.y),this.obj.translateZ(b.z),$(window).trigger("PROJECTILE_MOVE",{position:this.position})},this.checkPlaneCollision=function(a){i.set(this.position,h);var b=i.intersectObject(a);return b.length?(g=b,!1):!0},this.getPlaneCollision=function(){return console.log("Projectile.getPlaneCollision",g),g?g[0].point:!1},this.checkPlayerCollision=function(a){return Utils.PointInBox(this.position,a.bbox.box)?this.position:!1}},Scene=function(){function a(){requestAnimationFrame(a);var f=Game.getPlayers();if(d&&d.length)for(var g in d){d[g].applyForce(gravity),d[g].update();for(var h in f){var i=d[g].checkPlayerCollision(f[h]);if(0!=i){b.remove(d[g].obj),d=[],$(window).trigger("PROJECTILE_IMPACT",{point:i}),f[h].registerHit(),e.showImpact(i,16711680);break}}if(d[g]&&d[g].checkPlaneCollision(e.objForHittest)){var j=d[g].getPlaneCollision();j||(j=d[g].position),e.showImpact(j,3355443),$(window).trigger("PROJECTILE_IMPACT",{point:j}),b.remove(d[g].obj),d=[];break}}CameraManager.update(),c.render(b,CameraManager.getCamera())}var b,c,d,e,f=function(a){console.log("Scene.init()"),b=new THREE.Scene,CameraManager.init(),b.add(CameraManager.getCameraDolly()),c=new THREE.WebGLRenderer({canvas:document.getElementById("gamecanvas")}),c.setSize(window.innerWidth,window.innerHeight);var f=new THREE.DirectionalLight(16777215,.5);f.position.set(0,1,0),b.add(f),e=new Terrain,e.init(),b.add(e.obj),e.generatePlayerPositions(a,b),gravity=new Force(new THREE.Vector3(0,-.055,0)),d=[]},g=function(){a()},h=function(a){b.add(a.obj),$(a).on("PROJECTILE_FIRED",function(a,b){i(b)}),b.add(a.indicator)},i=function(a){d.push(a),b.add(a.obj)};return{init:f,start:g,addPlayer:h,addProjectile:i,getTerrain:function(){return e},setRendererSize:function(a,b){c&&c.setSize(a,b)}}}();Terrain=function(){function a(){return b.vertices[Math.floor(Math.random()*b.vertices.length)]}var b,c,d,e,f,g=400,h=400,i=400,j=400,k=80,l=80,m=1;this.init=function(){f=new Noise(Math.random()),b=new THREE.PlaneGeometry(g,h,i,j);for(var a=0;a<b.vertices.length;a++){var k=b.vertices[a].x,l=b.vertices[a].y;b.vertices[a].z+=f.perlin2(k,l)+f.perlin2(k/2,l/2)+4*f.perlin2(k/8,l/8)+16*f.perlin2(k/32,l/32),b.vertices[a].x+=f.perlin2(k,l),b.vertices[a].y+=f.perlin2(k,l)}b.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),b.verticesNeedUpdate=!0;var m=new THREE.MeshDepthMaterial;this.obj=new THREE.Object3D,c=new THREE.Mesh(b,m),c.userData={name:"shaded"},d=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:3355443,wireframe:!0,wireframeLinewidth:.5})),d.userData.name="wire",e=new THREE.Object3D,e.userData.name="effects",this.obj.add(c),this.obj.add(e),this.objForHittest=c},this.generatePlayerPositions=function(b){for(var c=[],d=0;b>d;d++){for(var e,f=!1;!f;)if(e=a(),e.x>-k/2&&e.x<k/2&&e.z>-l/2&&e.z<l/2&&(f=!0,c.length>0))for(var g=0;g<c.length;g++){c[g]==e&&(f=!1);var h=e.distanceTo(c[g]);.35>h/k&&(f=!1)}e.y+=m,c.push(e)}return this.playerPositions=c,this.playerPositions},this.closestOtherPlayer=function(a,b){console.log("Terrain.closestOtherPlayer()",a,b);var c=null,d=null;for(pos in this.playerPositions)if(this.playerPositions[pos]!=b){var e=a.distanceTo(this.playerPositions[pos]);(null===c||c>e)&&(d=this.playerPositions[pos],c=e)}if(!d)throw new Error("Terrain.closestOtherPlayer() could not determine closest player to ",a);return{position:d,distance:c}},this.showImpact=function(a,b){var c=new THREE.SphereGeometry(1,4,4);c.applyMatrix((new THREE.Matrix4).setPosition(a));var d=new THREE.MeshBasicMaterial({color:b}),e=new THREE.Mesh(c,d);Utils.Object3DgetChildByName(this.obj,"effects").add(e)}};var UI=function(){function a(){var a=window.innerWidth,b=window.innerHeight;$("#gamecanvas").css("width",a+"px"),$("#gamecanvas").css("height",b+"px"),CameraManager.updateAspect(a/b),Scene.setRendererSize(a,b)}function b(a){$("#player-"+a.currentTarget.id).css("border","1px solid red").find(".player-life").animate({width:a.currentTarget.life}).find("span").html(a.currentTarget.life)}function c(a){var b=$(a.target).val();for(i.show(),$("#start button").removeAttr("disabled");i.children(".playerRow").length<b;){var c=i.children(".playerRow").length;i.append(h({num:c+1}))}for(;i.children(".playerRow").length>b;)i.children(".playerRow:last").remove()}function d(a){e(),$("#menus").fadeIn(),$(a).show()}function e(){$("#menus").hide().children().hide()}function f(){$("#hud").show()}var g=["#66d78b","#1c5ed7","#b0116f","#ffd800"],h=Handlebars.compile($("#playerRowTemplate").html()),i=$("#start table"),j=Handlebars.compile($("#playerHUDTemplate").html()),k=$("#hud table"),l=4,m=function(){$(window).on("resize",a),a(),$("#ui-start-game").on("click",n),$("#ui-restart-game").on("click",function(){window.location.reload()}),$("#menus [name=numPlayers]").on("change",c),d("#start"),Game.init(l)},n=function(){if(console.log("UI.startGame()"),i.children(".playerRow").length<1)return alert("Select a number of players"),!1;var a=[];i.children(".playerRow").each(function(){var c=$(this),d={name:c.find("input[name=playerName]").val(),color:g[a.length],id:a.length},e=null;d.name||(d.name="Player "+(a.length+1)),e="human"==c.find("select").val()?new HumanPlayer(d):new AIPlayer(d),k.append(j(d)),$(e).on("CHANGE_LIFE",b),a.push(e)}),e(),Game.addPlayers(a),Game.start(),f()},o=function(a){$("#winner").find("span").html(a.name),d("#winner")};return{init:m,startGame:n,showWin:o}}(),Utils=function(){return{Object3DgetChildByName:function(a,b){for(child in a.children)if(a.children[child].userData&&a.children[child].userData.name&&a.children[child].userData.name==b)return a.children[child];return!1},PointInBox:function(a,b){var c=a.x>b.min.x&&a.x<b.max.x&&a.y>b.min.y&&a.y<b.max.y&&a.z>b.min.z&&a.z<b.max.z;return c},HelperLine:function(a,b,c){var d=new THREE.Geometry;for(i in a)d.vertices.push(a[i]);c&&d.applyMatrix((new THREE.Matrix4).setPosition(c));var e=new THREE.LineBasicMaterial({color:b?b:16711680});return new THREE.Line(d,e)}}}();$(function(){UI.init()});