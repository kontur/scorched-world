function Player(){this.position=null,this.mesh=null,this.direction=null,this.firingV=null,this.init=function(){var a=new THREE.IcosahedronGeometry(1,0),b=new THREE.MeshPhongMaterial({ambient:16711680,color:16724736,specular:39423,shininess:30,shading:THREE.FlatShading});this.mesh=new THREE.Mesh(a,b),this.obj=new THREE.Object3D;var c=2,d=new THREE.CylinderGeometry(.15,.5,c);d.applyMatrix((new THREE.Matrix4).makeTranslation(0,c/2,0));var e=new THREE.MeshPhongMaterial({ambient:16711680,color:65535,specular:39423,shininess:30,shading:THREE.FlatShading});this.canon=new THREE.Mesh(d,e),this.obj.add(this.mesh),this.obj.add(this.canon),this.canon.rotateX(45*Math.PI/180),this.canon.rotationAutoUpdate},this.setPosition=function(a){console.log("Player.setPosition",a),this.position=a,this.obj.translateX(a.x),this.obj.translateY(a.y),this.obj.translateZ(a.z);var b=new THREE.Geometry;b.vertices.push(this.position),b.vertices.push(new THREE.Vector3(this.position.x,10,this.position.z));var c=new THREE.LineBasicMaterial({color:16711680});this.firingV=new THREE.Line(b,c)},this.fire=function(){var a=new Projectile;a.direction=this.getFiringVector(),a.mass=.551,a.setPosition(this.position.clone()),$(this).trigger("PROJECTILE_FIRED",a)},this.addAngle=function(a){this.canon.rotation.x+a>0&&this.canon.rotation.x+a<Math.PI/2&&this.canon.rotateX(a),this.getFiringVector()},this.addRotation=function(a){this.obj.rotateOnAxis(new THREE.Vector3(0,1,0),a),this.getFiringVector()},this.getFiringVector=function(){var a=new THREE.Matrix4;a=a.extractRotation(this.obj.matrix);var b=new THREE.Vector3(0,0,1);b=b.applyMatrix4(a);var c=new THREE.Matrix4;c=c.extractRotation(this.canon.matrix);var d=(new THREE.Matrix4).makeRotationX(-Math.PI/4),e=new THREE.Vector3(0,1,1);e=e.applyMatrix4(d),e=e.applyMatrix4(c),e=e.applyMatrix4(a);var f=new THREE.Geometry;f.vertices.push(this.position),f.vertices.push(this.position.clone().add(e.clone().multiplyScalar(5)));var g=new THREE.LineBasicMaterial({color:17408});for(this.firingV.add(new THREE.Line(f,g)),console.log(this.firingV.children.length);this.firingV.children.length>10;)this.firingV.children.shift();return e}}function HumanPlayer(){function a(){console.log("HumanPlayer.setupControls()"),$(window).on("keydown",b)}function b(a){if(!c.controlsEnabled)return!1;var b=5;switch(a.keyCode){case 38:c.addAngle(b*(Math.PI/180));break;case 40:c.addAngle(-b*(Math.PI/180));break;case 37:c.addRotation(-b*(Math.PI/180));break;case 39:c.addRotation(b*(Math.PI/180));break;case 32:c.fire()}}var c=this;this.controlsEnabled=!1,this.enableControls=function(){this.controlsEnabled=!0},this.disableControls=function(){this.controlsEnabled=!1},Player.call(this),a()}var Force=function(a){this.direction=a};Force.prototype={};var Game=function(){var a=function(){var a;Scene.init(),Scene.start(),a=new HumanPlayer,a.enableControls(),a.init(),a.setPosition(Scene.getTerrain().playerPositions[0]),Scene.addPlayer(a)};return{start:a,reset:a}}();HumanPlayer.prototype=new Player,HumanPlayer.constructor=HumanPlayer;var Projectile=function(){var a=new THREE.SphereGeometry(.25,4,4),b=new THREE.MeshBasicMaterial({color:16711935}),c=new THREE.Mesh(a,b),d=null,e=new THREE.Vector3(0,-1,0),f=new THREE.Raycaster(this.position,e);this.mass=.1,this.direction=new THREE.Vector3(0,0,0),this.position=new THREE.Vector3(0,0,0),this.drag=.01,this.obj=new THREE.Object3D,this.obj.add(c),this.obj.position=new THREE.Vector3(0,0,0),this.applyForce=function(a){this.direction=this.direction.add(a.direction.clone().multiplyScalar(1+this.mass))},this.setPosition=function(a){this.position=a},this.update=function(){this.position=this.position.add(this.direction);var a=(new THREE.Vector3).subVectors(this.position,this.obj.position);this.obj.translateX(a.x),this.obj.translateY(a.y),this.obj.translateZ(a.z)},this.checkPlaneCollision=function(a){f.set(this.position,e);var b=f.intersectObject(a);return b.length?(d=b,!1):!0},this.getPlaneCollision=function(){return d?d:!1}},Scene=function(){function a(){if(requestAnimationFrame(a),e&&e.length)for(p in e)e[p].applyForce(gravity),e[p].update(),e[p].checkPlaneCollision(g.objForHittest)&&(g.showImpact(e[p].getPlaneCollision()[0]),b.remove(e[p].obj),e=[]);d.render(b,c)}var b,c,d,e,f,g,h=function(){console.log("Scene.init()"),b=new THREE.Scene,c=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,150),d=new THREE.WebGLRenderer({canvas:document.getElementById("gamecanvas")}),d.setSize(window.innerWidth,window.innerHeight);var a=new THREE.DirectionalLight(16777215,.5);a.position.set(0,1,0),b.add(a),g=new Terrain,g.init(),b.add(g.obj),g.generatePlayerPositions(2,b),gravity=new Force(new THREE.Vector3(0,-.055,0)),e=[]},i=function(){a()},j=function(a){b.add(a.obj),c.position.y=25,c.lookAt(a.position),$(a).on("PROJECTILE_FIRED",function(a,b){console.log("addPlayer, onPROJECTILE_FIRED",a,b),k(b)}),f=a,b.add(a.firingV),console.log("addPlayer",a.firingV)},k=function(a){console.log("Scene.addProjectile()",a),e.push(a),b.add(a.obj),console.log("Scene.addProjectile",e.length)};return{init:h,start:i,addPlayer:j,addProjectile:k,getTerrain:function(){return g}}}();Terrain=function(){function a(){return b.vertices[Math.floor(Math.random()*b.vertices.length)]}var b,c,d,e,f=100,g=100,h=30,i=30;this.init=function(){b=new THREE.PlaneGeometry(f,g,h,i);for(var a=0;a<b.vertices.length;a++)b.vertices[a].z+=2*Math.random(),b.vertices[a].x+=Math.random()-.5,b.vertices[a].y+=Math.random()-.5;b.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),b.verticesNeedUpdate=!0;var j=new THREE.MeshDepthMaterial;this.obj=new THREE.Object3D,c=new THREE.Mesh(b,j),c.userData={name:"shaded"},d=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:3355443,wireframe:!0,wireframeLinewidth:2.5})),d.userData.name="wire",e=new THREE.Object3D,e.userData.name="effects",this.obj.add(c),this.obj.add(d),this.obj.add(e),this.objForHittest=c},this.generatePlayerPositions=function(b){for(var c=[],d=0;b>d;d++)c.push(a());this.playerPositions=c},this.showImpact=function(a){var b=new THREE.SphereGeometry(1,4,4);b.applyMatrix((new THREE.Matrix4).setPosition(a.point));var c=new THREE.MeshBasicMaterial({color:16724736}),d=new THREE.Mesh(b,c);Utils.Object3DgetChildByName(this.obj,"effects").add(d)}};var UI=function(){function a(){console.log("hello resize");var a=$(window).width(),b=$(window).height();$("#gamecanvas").css("width",a+"px"),$("#gamecanvas").css("height",b+"px")}function b(){Game.reset()}var c=function(){$(window).on("resize",a),a(),console.log("hello ui init"),$("#ui-reset-scene").on("click",b)};return{init:c}}(),Utils=function(){return{Object3DgetChildByName:function(a,b){console.log(a,b);for(child in a.children)if(a.children[child].userData&&a.children[child].userData.name&&a.children[child].userData.name==b)return a.children[child];return!1}}}();$(function(){UI.init(),Game.start()});